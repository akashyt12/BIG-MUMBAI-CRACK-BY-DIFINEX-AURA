<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>BIG MUMBAI • ADMIN</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;font-family:Orbitron;background:#000;color:#00ffcc}
.container{max-width:900px;margin:auto;padding:20px}
.card{
  background:#050505;
  border:1px solid #00ffcc55;
  border-radius:14px;
  padding:15px;
  margin-top:15px;
  box-shadow:0 0 20px #00ffcc33;
}
input,button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:10px;
  border:none;
  font-family:Orbitron;
}
input{background:#000;border:1px solid #00ffcc;color:#00ffcc}
button{background:#00ffcc;color:#000;font-weight:700}
button.off{background:#111;color:#ff4444;border:1px solid #ff4444}
.status{font-size:12px;margin-top:6px}
.hidden{display:none}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="container" id="loginBox">
  <div class="card">
    <h3>ADMIN LOGIN</h3>
    <input id="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Password">
    <button onclick="login()">LOGIN</button>
  </div>
</div>

<!-- PANEL -->
<div class="container hidden" id="panel">
  <h2>BIG MUMBAI SERVER</h2>
  <div id="uids"></div>
  <button onclick="addUID()">➕ ADD UID</button>
</div>

<script>
/* ================= LOGIN PERSIST ================= */
function login(){
  if(email.value==="admin@gmail.com" && pass.value==="admin902zx"){
    localStorage.setItem("logged","yes");
    openPanel();
  }else alert("Wrong login");
}

function openPanel(){
  loginBox.classList.add("hidden");
  panel.classList.remove("hidden");
}

if(localStorage.getItem("logged")==="yes"){
  openPanel();
}

/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyCgUHPXpBvpi0cEF2vQ2z8J-c8jI1cj1ko",
  databaseURL:"https://admin-pannel-de3f4-default-rtdb.firebaseio.com",
  projectId:"admin-pannel-de3f4"
});
const db=firebase.database();

/* ================= API ================= */
const API_URL="https://draw.ar-lottery01.com/WinGo/WinGo_1M/GetHistoryIssuePage.json?pageSize=10&pageNo=1";

let uidCount=0;
let loops={};
let lastIssueMap={};

/* ================= ADD UID ================= */
function addUID(){
  uidCount++;
  uids.innerHTML+=`
  <div class="card">
    <h4>UID ${uidCount}</h4>
    <input id="uid_${uidCount}" placeholder="Enter UID">
    <button onclick="connect(${uidCount})">SERVER CONNECT</button>
    <button class="off" onclick="off(${uidCount})">SERVER OFF</button>
    <div class="status" id="st_${uidCount}">Idle</div>
  </div>`;
}

/* ================= PREDICTION LOGIC ================= */
function predictNext(nums){
  let score=0;
  nums.forEach((n,i)=>{
    let w=10-i;
    score+=(n>=5?w:-w);
  });

  let big=nums.filter(n=>n>=5).length;
  let small=nums.length-big;
  if(big>=8)score-=10;
  if(small>=8)score+=10;

  score+=Math.floor(Math.random()*7)-3;

  let side=score>=0?"BIG":"SMALL";
  let num=side==="BIG"?6+Math.floor(Math.random()*4):Math.floor(Math.random()*5);
  return side+" "+num;
}

/* ================= FETCH + SEND ================= */
async function send(uid,st){
  try{
    const r=await fetch(API_URL+"&t="+Date.now(),{cache:"no-store"});
    const j=await r.json();
    const list=j.data.list;
    const issue=list[0].issueNumber;

    if(lastIssueMap[uid]===issue)return;
    lastIssueMap[uid]=issue;

    const nums=list.map(x=>Number(x.number));
    const res=predictNext(nums);

    await db.ref("prediction/"+uid).set({
      prediction:res,
      issue:issue,
      time:Date.now()
    });

    st.innerText="Connected ✓ | "+res;
  }catch(e){
    st.innerText="Reconnecting...";
  }
}

/* ================= CONNECT ================= */
function connect(i){
  const uid=document.getElementById("uid_"+i).value;
  const st=document.getElementById("st_"+i);
  if(!uid||loops[uid])return;

  localStorage.setItem("uid_"+uid,"on");
  send(uid,st);
  loops[uid]=setInterval(()=>send(uid,st),60000);
}

/* ================= OFF ================= */
function off(i){
  const uid=document.getElementById("uid_"+i).value;
  const st=document.getElementById("st_"+i);
  if(loops[uid]){
    clearInterval(loops[uid]);
    delete loops[uid];
  }
  localStorage.removeItem("uid_"+uid);
  db.ref("prediction/"+uid).remove();
  st.innerText="Server OFF";
}

/* ================= AUTO RESUME AFTER REFRESH ================= */
window.addEventListener("load",()=>{
  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith("uid_") && localStorage.getItem(k)==="on"){
      const uid=k.replace("uid_","");
      addUID();
      document.getElementById("uid_"+uidCount).value=uid;
      connect(uidCount);
    }
  });
});

/* ================= VISIBILITY KEEP ALIVE ================= */
document.addEventListener("visibilitychange",()=>{
  if(!document.hidden){
    Object.keys(loops).forEach(uid=>{
      const st=document.querySelector(`#st_${uid}`);
      if(st)send(uid,st);
    });
  }
});
</script>

</body>
</html>
